################################################################################
# Stack: Supabase Self-Hosted
# Descricao: Backend completo com Auth, Realtime, REST API e Vector DB
# Autor: Gemini - Aiknow Systems
################################################################################

x-common: &common
  restart: unless-stopped
  networks:
    - llmserver

services:
  db:
    image: supabase/postgres:15.1.1.78
    container_name: supabase-db
    <<: *common
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./volumes/db/data:/var/lib/postgresql/data

  auth:
    image: supabase/gotrue:v2.132.3
    container_name: supabase-auth
    <<: *common
    environment:
      GOTRUE_DB_DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/postgres
      GOTRUE_JWT_SECRET: ${JWT_SECRET}
      GOTRUE_SITE_URL: ${SITE_URL}

  rest:
    image: postgrest/postgrest:v12.0.1
    container_name: supabase-rest
    <<: *common
    environment:
      PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/postgres
      PGRST_JWT_SECRET: ${JWT_SECRET}

  studio:
    image: supabase/dashboard:v0.23.10
    container_name: supabase-studio
    <<: *common
    ports:
      - "${STUDIO_PORT:-8000}:3000"
    environment:
      SUPABASE_PUBLIC_URL: ${SITE_URL}

  kong:
    image: kong:2.8.1
    container_name: supabase-kong
    <<: *common
    ports:
      - "8000:8000"
    volumes:
      - ./volumes/api/kong.yml:/var/lib/kong/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml

networks:
  llmserver:
    external: true
